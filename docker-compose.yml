version: '3.8'

services:
  # Init контейнер: копирует зависимости из образа в volume при первом запуске
  # Запускается один раз при создании volume
  ocr-pipeline-init:
    build:
      context: .
      dockerfile: Dockerfile.pipeline
    image: ocr-pipeline:latest
    volumes:
      - ocr-pipeline-deps:/deps
    command: >
      sh -c "
        if [ ! -f /deps/.initialized ]; then
          echo '========================================'
          echo 'Initializing OCR Pipeline dependencies...'
          echo '========================================'
          echo 'Copying dependencies from image to volume...'
          cp -r /deps-source/* /deps/ 2>/dev/null || true
          touch /deps/.initialized
          echo '✓ Dependencies copied successfully'
          echo '========================================'
        else
          echo 'Dependencies already initialized'
        fi
      "
    profiles:
      - init

  # Контейнер с OCR Pipeline и зависимостями
  # Этот контейнер просто держит зависимости в образе
  # Реальные зависимости используются из volume, который заполнен init контейнером
  ocr-pipeline:
    build:
      context: .
      dockerfile: Dockerfile.pipeline
    image: ocr-pipeline:latest
    container_name: ocr-pipeline
    volumes:
      - ocr-pipeline-deps:/deps:ro
    networks:
      - open-webui-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "PYTHONPATH=/deps python -c 'import fitz; import docx; import PIL; import cv2'"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Оригинальный OpenWebUI контейнер
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    ports:
      - "3000:8080"
    volumes:
      # Данные OpenWebUI
      - open-webui-data:/app/backend/data
      # Монтируем код пайплайна напрямую с хоста
      - ./OCR:/app/pipelines/OCR:ro
      # Монтируем зависимости из контейнера ocr-pipeline
      - ocr-pipeline-deps:/app/pipelines-deps:ro
    environment:
      - ENABLE_PIPELINES=true
      # Добавляем путь к зависимостям в PYTHONPATH
      - PYTHONPATH=/app/pipelines-deps:${PYTHONPATH}
      # Настройки VLM API (можно переопределить через .env)
      - VLM_API_URL=${VLM_API_URL:-http://host.docker.internal:8000/v1}
      - VLM_API_KEY=${VLM_API_KEY:-token-abc}
      - VLM_MODEL_NAME=${VLM_MODEL_NAME:-qwen3vl-8b-instruct-fp8}
    depends_on:
      ocr-pipeline:
        condition: service_started
    networks:
      - open-webui-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  open-webui-data:
    driver: local
  ocr-pipeline-deps:  # Volume для зависимостей (создается при сборке ocr-pipeline)
    driver: local

networks:
  open-webui-network:
    driver: bridge

