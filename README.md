# OCR Pipeline для OpenWebUI

Пайплайн для двухэтапного OCR обработки документов с интеграцией в OpenWebUI.

## Описание

Пайплайн принимает на вход файлы различных форматов (PDF, Word документы с изображениями, или прямые изображения) и выполняет двухэтапную обработку:
1. **OCR → Markdown**: Распознавание текста и таблиц из изображений с преобразованием в Markdown
2. **Markdown → JSON**: Преобразование структурированного Markdown в JSON формат

На выходе пользователь получает структурированный JSON с извлеченными данными.

## Архитектура

Проект следует лучшим практикам создания пайплайнов:

```
OCR/
├── __init__.py              # Точка входа для OpenWebUI (класс Pipeline с методом on_file)
├── pipeline.py              # Основной пайплайн OCR (класс OCRPipeline)
├── file_processor.py        # Обработка различных типов файлов (PDF, DOCX, изображения)
├── validators.py            # Валидация входных данных
├── pdf_handler.py           # Извлечение и подготовка изображений из PDF (legacy, используется FileProcessor)
├── image_enhancer.py        # Улучшение качества сканов для OCR
├── vlm_client.py           # Работа с VLM через OpenAI-совместимый API (асинхронные функции)
├── markdown_postproc.py    # Постобработка OCR-результата
├── prompts.py              # Промпты для VLM
├── schemas.py              # Pydantic-модели и парсер
└── config.py               # Конфигурация (URL, токен, модель и т.д.)
```

## Поддерживаемые форматы

### Входные форматы:
- **PDF** (.pdf) - извлекаются страницы как изображения
- **Word документы** (.docx, .doc) - извлекаются встроенные изображения
- **Изображения** (.jpg, .jpeg, .png, .gif, .bmp, .tiff, .webp) - обрабатываются напрямую

### Выходной формат:
- **JSON** - структурированные данные с извлеченными таблицами и метаданными

## Основные компоненты

### OCRPipeline (`pipeline.py`)
Основной класс пайплайна, который координирует все этапы обработки:
- Определение типа файла
- Извлечение изображений
- Двухэтапный OCR (Markdown → JSON)
- Обработка ошибок

### FileProcessor (`file_processor.py`)
Универсальный обработчик файлов:
- Автоматическое определение типа файла по магическим байтам и расширению
- Извлечение изображений из PDF, DOCX и прямых изображений
- Тайлинг больших изображений для обработки VLM
- Улучшение качества изображений для OCR

### Валидация (`validators.py`)
Валидация входных данных от OpenWebUI:
- Проверка структуры запроса
- Валидация информации о файлах
- Проверка наличия данных

## Использование

### Интеграция с OpenWebUI

Пайплайн интегрируется с OpenWebUI через класс `Pipeline` с асинхронным методом `on_file()`:

```python
class Pipeline:
    def __init__(self):
        """Инициализирует пайплайн."""
        self.ocr_pipeline = OCRPipeline()

    async def on_file(self, file: Dict[str, Any]) -> Dict[str, Any]:
        """Асинхронно обрабатывает файл через двухэтапный OCR пайплайн."""
        # Обработка файла и возврат словаря с результатом
```

OpenWebUI автоматически создает экземпляр класса `Pipeline` и вызывает метод `on_file()` для каждого загруженного файла.

### Пример использования

```python
from OCR import Pipeline

# OpenWebUI автоматически создаст экземпляр
pipeline = Pipeline()

# Метод вызывается для каждого файла
result = await pipeline.on_file({
    "data": "base64_data_или_data_url",
    "name": "document.pdf"
})
# Возвращает словарь с результатом или {"error": "..."}
```

## Зависимости

Основные зависимости:
- `PyMuPDF` (fitz) - обработка PDF
- `python-docx` - обработка Word документов
- `Pillow` (PIL) - работа с изображениями
- `opencv-python` (cv2) - улучшение изображений
- `langchain-openai` - работа с VLM API
- `pydantic` - валидация данных
- `langchain-core` - базовые компоненты LangChain

## Конфигурация

Настройки находятся в `config.py`:
- URL VLM API
- API ключ
- Имя модели
- Параметры температуры и штрафов
- Параметры обработки изображений (DPI, размер тайлов, перекрытие)

## Обработка ошибок

Пайплайн включает многоуровневую обработку ошибок:
1. Валидация входных данных
2. Проверка типа файла
3. Проверка наличия изображений
4. Проверка результатов OCR
5. Обработка исключений с информативными сообщениями

Все ошибки возвращаются в формате JSON с полем `error`.

## Лучшие практики

Проект следует следующим принципам:

1. **Разделение ответственности**: Каждый модуль отвечает за свою область
2. **Модульность**: Компоненты легко тестировать и заменять
3. **Валидация**: Проверка данных на всех этапах
4. **Обработка ошибок**: Информативные сообщения об ошибках
5. **Типизация**: Использование type hints для лучшей читаемости
6. **Документация**: Docstrings для всех публичных методов
7. **Расширяемость**: Легко добавить поддержку новых форматов

## Расширение функциональности

Для добавления поддержки нового формата файлов:

1. Добавьте определение типа в `FileProcessor.detect_file_type()`
2. Реализуйте метод извлечения изображений в `FileProcessor`
3. Добавьте обработку в `OCRPipeline._extract_images()`

## Установка и запуск с Docker

### Требования

- Docker и Docker Compose установлены
- VLM API доступен (локально или в Docker сети)

### Быстрый старт

1. **Клонируйте или скопируйте проект**

2. **Настройте переменные окружения (опционально)**

   Создайте файл `.env` на основе `.env.example`:
   ```bash
   cp .env.example .env
   # Отредактируйте .env и укажите настройки VLM API
   ```

3. **Соберите и запустите контейнеры**

   ```bash
   # Сборка контейнера пайплайна
   docker-compose build ocr-pipeline

   # Запуск всех сервисов
   docker-compose up -d

   # Просмотр логов
   docker-compose logs -f
   ```

4. **Проверьте работу**

   - Откройте OpenWebUI: http://localhost:3000
   - Загрузите файл (PDF/DOCX/изображение)
   - Пайплайн автоматически обработает файл

### Структура Docker контейнеров

Проект использует архитектуру с sidecar контейнером:

```
┌─────────────────────┐
│  ocr-pipeline       │  ← Контейнер с пайплайном и зависимостями
│  - Код пайплайна    │
│  - Python зависимости│
└─────────────────────┘
         │
         │ Shared Volume
         ▼
┌─────────────────────┐
│  open-webui          │  ← Оригинальный OpenWebUI контейнер
│  - Монтирует пайплайн│
│  - Использует зависимости│
└─────────────────────┘
```

### Проверка установки

```bash
# Проверьте, что контейнеры запущены
docker-compose ps

# Проверьте логи пайплайна
docker-compose logs ocr-pipeline

# Проверьте логи OpenWebUI
docker-compose logs open-webui

# Проверьте установку зависимостей в контейнере пайплайна
docker exec -it ocr-pipeline python -c "import fitz; import docx; import PIL; import cv2; print('All OK')"

# Проверьте, что пайплайн виден в OpenWebUI
docker exec -it open-webui ls -la /app/pipelines/OCR
```

### Настройка VLM API

Если VLM API запущен в другой Docker сети:

1. **Добавьте VLM API в docker-compose.yml:**

   ```yaml
   services:
     vlm-api:
       image: your-vlm-api-image:latest
       container_name: vlm-api
       ports:
         - "8000:8000"
       networks:
         - open-webui-network

     open-webui:
       # ...
       environment:
         - VLM_API_URL=http://vlm-api:8000/v1  # Используйте имя сервиса
   ```

2. **Или если VLM API на хосте:**

   ```yaml
   open-webui:
     extra_hosts:
       - "host.docker.internal:host-gateway"
     environment:
       - VLM_API_URL=http://host.docker.internal:8000/v1
   ```

### Обновление пайплайна

После изменения кода пайплайна:

```bash
# Пересоберите контейнер пайплайна
docker-compose build ocr-pipeline

# Перезапустите контейнеры
docker-compose restart ocr-pipeline open-webui
```

### Остановка и очистка

```bash
# Остановка контейнеров
docker-compose down

# Остановка с удалением volumes (удалит все данные!)
docker-compose down -v
```

## Лицензия

[Укажите лицензию проекта]
