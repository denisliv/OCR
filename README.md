# OCR Pipeline для OpenWebUI

Пайплайн для двухэтапного OCR обработки документов с интеграцией в OpenWebUI.

## Описание

Пайплайн принимает на вход файлы различных форматов (PDF, Word документы с изображениями, или прямые изображения) и выполняет двухэтапную обработку:
1. **OCR → Markdown**: Распознавание текста и таблиц из изображений с преобразованием в Markdown
2. **Markdown → JSON**: Преобразование структурированного Markdown в JSON формат

На выходе пользователь получает структурированный JSON с извлеченными данными.

## Архитектура

Проект следует лучшим практикам создания пайплайнов для OpenWebUI:

```
OCR/
├── __init__.py              # Точка входа для OpenWebUI (экспорт класса Pipeline)
├── pipeline.py              # Основной пайплайн OCR (класс Pipeline с методом pipe)
├── file_processor.py        # Обработка различных типов файлов (PDF, DOCX, изображения)
├── image_enhancer.py        # Улучшение качества сканов для OCR
├── markdown_postproc.py     # Постобработка OCR-результата
├── prompts.py               # Промпты для VLM
├── schemas.py               # Pydantic-модели и парсер
└── config.py                # Конфигурация (URL, токен, модель и т.д.)
```

## Поддерживаемые форматы

### Входные форматы:
- **PDF** (.pdf) - извлекаются страницы как изображения
- **Word документы** (.docx, .doc) - извлекаются встроенные изображения
- **Изображения** (.jpg, .jpeg, .png, .gif, .bmp, .tiff, .webp) - обрабатываются напрямую

### Выходной формат:
- **JSON** - структурированные данные с извлеченными таблицами и метаданными

## Основные компоненты

### Pipeline (`pipeline.py`)
Основной класс пайплайна, который координирует все этапы обработки:
- Определение типа файла
- Извлечение изображений
- Двухэтапный OCR (Markdown → JSON)
- Обработка ошибок

Класс `Pipeline` является входной точкой для OpenWebUI и должен иметь:
- Класс `Valves` с настройками (наследуется от `BaseModel`)
- Метод `__init__()` для инициализации
- Метод `pipe()` для обработки запросов
- Опциональные методы `on_startup()` и `on_shutdown()`

### FileProcessor (`file_processor.py`)
Универсальный обработчик файлов:
- Автоматическое определение типа файла по магическим байтам и расширению
- Извлечение изображений из PDF, DOCX и прямых изображений
- Тайлинг больших изображений для обработки VLM
- Улучшение качества изображений для OCR

## Использование

### Интеграция с OpenWebUI

Пайплайн интегрируется с OpenWebUI через класс `Pipeline` с методом `pipe()`:

```python
class Pipeline:
    class Valves(BaseModel):
        VLM_API_URL: str
        VLM_API_KEY: str
        VLM_MODEL_NAME: str

    def __init__(self):
        self.name = "OCR Pipeline"
        self.valves = self.Valves(...)

    def pipe(self, user_message: str, model_id: str, messages: List[dict], body: dict) -> Union[str, Generator, Iterator]:
        # Обработка файлов из body["files"]
        # Возврат результата в виде строки или генератора
```

OpenWebUI автоматически создает экземпляр класса `Pipeline` и вызывает метод `pipe()` для каждого запроса с файлами.

### Установка

1. Скопируйте папку `OCR` в директорию `/app/pipelines/` контейнера OpenWebUI или смонтируйте её через volume.

2. Установите зависимости в контейнере OpenWebUI:

```bash
pip install -r requirements.txt
```

3. Настройте переменные окружения (опционально):

```bash
export VLM_API_URL="http://localhost:8000/v1"
export VLM_API_KEY="your-api-key"
export VLM_MODEL_NAME="qwen3vl-8b-instruct-fp8"
```

Или установите их в `config.py` напрямую.

## Зависимости

Основные зависимости (см. `requirements.txt`):
- `PyMuPDF` (fitz) - обработка PDF
- `python-docx` - обработка Word документов
- `Pillow` (PIL) - работа с изображениями
- `opencv-python` (cv2) - улучшение изображений
- `langchain-openai` - работа с VLM API
- `langchain-core` - базовые компоненты LangChain
- `pydantic` - валидация данных
- `nest-asyncio` - для работы с асинхронностью

## Конфигурация

Настройки находятся в `config.py` или могут быть заданы через переменные окружения:
- `VLM_API_URL` - URL VLM API (по умолчанию: `http://localhost:8000/v1`)
- `VLM_API_KEY` - API ключ (по умолчанию: `token-abc`)
- `VLM_MODEL_NAME` - Имя модели (по умолчанию: `qwen3vl-8b-instruct-fp8`)
- Параметры температуры и штрафов для OCR и JSON этапов
- Параметры обработки изображений (DPI, размер тайлов, перекрытие)

## Обработка ошибок

Пайплайн включает многоуровневую обработку ошибок:
1. Проверка наличия файлов в запросе
2. Проверка типа файла
3. Проверка наличия изображений
4. Проверка результатов OCR
5. Обработка исключений с информативными сообщениями

Все ошибки возвращаются в виде строки с описанием проблемы.

## Лучшие практики

Проект следует следующим принципам:

1. **Разделение ответственности**: Каждый модуль отвечает за свою область
2. **Модульность**: Компоненты легко тестировать и заменять
3. **Обработка ошибок**: Информативные сообщения об ошибках
4. **Типизация**: Использование type hints для лучшей читаемости
5. **Документация**: Docstrings для всех публичных методов
6. **Расширяемость**: Легко добавить поддержку новых форматов

## Расширение функциональности

Для добавления поддержки нового формата файлов:

1. Добавьте определение типа в `FileProcessor.detect_file_type()`
2. Реализуйте метод извлечения изображений в `FileProcessor`
3. Добавьте обработку в `Pipeline._extract_images()`

## Лицензия

[Укажите лицензию проекта]
